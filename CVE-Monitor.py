#-*- coding:utf-8 -*-

import requests
from bs4 import BeautifulSoup
from pymongo import MongoClient
from datetime import *
import time
import smtplib
from email.mime.text import MIMEText
from email.header import Header
import sys
from smtplib import SMTP_SSL

reload(sys)
sys.setdefaultencoding('utf8')

class CVEInfo:
    def __init__(self,url, cveid, keyword, description, company, createdate):
        self.url = url
        self.cveid = cveid
        self.keyword = keyword
        self.description = description
        self.company = company
        self.createdate = createdate

    def show(self):
        return '<p><b>漏洞编号：</b><a href="'+self.url+'">'+self.cveid+'</a></p><b>相关厂商：</b>'\
            +self.company +'<br><b>披露日期：</b>'\
            +self.createdate+'<br><b>关键字：</b><font size="3" color="red">'\
            +self.keyword+'</font><br><b>漏洞描述：</b>'\
            +self.description + '<br><br><hr/>'

    def add(self):
        data = {
            'cveid': self.cveid,
            'keyword': self.keyword,
            'description': self.description,
            'company': self.company,
            'createdate': datetime.strptime(self.createdate, "%Y%m%d"),
            'addDate': time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time())),

        }
        return data
headers = {
    'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:57.0) Gecko/20100101 Firefox/57.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
}

def getMiddleStr(content, startStr, endStr): # 获取文本中间内容
    startIndex = content.index(startStr)
    if startIndex >= 0:
        startIndex += len(startStr)
        endIndex = content.index(endStr)
    return content[startIndex:endIndex]


def getCVES():  # 获取最新到CVE列表
    urls = []
    try:
        url = 'https://cassandra.cerias.purdue.edu/CVE_changes/today.html'
        res = requests.get(url, headers=headers, timeout=60)
        CVEList_html = getMiddleStr(res.text, 'New entries:', 'Graduations')
        soup = BeautifulSoup(CVEList_html, 'html.parser')
        for a in soup.find_all('a'):
            urls.append(a['href'])
        return urls
    except Exception as e:
        print(e)


def getCVEDetail(url):  # 获取CVE详情
    keywords = ['WordPress','Struts','Jboss','Remote Code Execution Vulnerability'] #关注的关键字
    try:
        res = requests.get(url, headers=headers, timeout=60)
        soup = BeautifulSoup(res.text, 'html.parser')
        cveId = soup.find(nowrap='nowrap').find('h2').string
        table = soup.find(id='GeneratedTable').find('table')
        description = table.find_all('tr')[3].find('td').string
        keyword = None
        for k in keywords:
            if k in description:
                keyword = k
                break
        company = table.find_all('tr')[8].find('td').string
        createdate = table.find_all('tr')[10].find('td').string
        cveInfo = CVEInfo(url, cveId, keyword, description, company, createdate)
        if keyword is None:
            return None
        else:
            return cveInfo

    except Exception as e:
        print(e)

def addData(data):
    DBNAME = 'mydb'
    DBUSERNAME = 'xxx'
    DBPASSWORD = 'xxx'
    DB = '127.0.0.1'
    PORT = 65521
    db_conn = MongoClient(DB, PORT)
    na_db = getattr(db_conn, DBNAME)
    na_db.authenticate(DBUSERNAME, DBPASSWORD)
    c = na_db.cvedatas
    c.update({"cveid": data['cveid']}, {'$set': data}, True)

def sendEmail(mail_msg):  # 发送邮件
        # qq邮箱smtp服务器
        host_server = 'smtp.qq.com'
        sender_qq   = 'xxx'  #qq号
        sender_qq_mail = sender_qq+'@qq.com'  #
        pwd = 'xxxx'   #授权码
        receiver = 'xxxxx@qq.com' #收件人
        try:
            smtp = SMTP_SSL(host_server)
            #set_debuglevel()是用来调试的。参数值为1表示开启调试模式，参数值为0关闭调试模式
            smtp.set_debuglevel(1)
            smtp.ehlo(host_server)
            smtp.login(sender_qq, pwd)
            msg = MIMEText(mail_msg, "html", 'utf-8')
            msg["From"] = sender_qq_mail
            msg["To"] = receiver
            smtp.sendmail(sender_qq_mail, receiver, msg.as_string())
        except smtplib.SMTPException:
            print('Error: 无法发送邮件')
def main():
    nowTime = '当前时间：<font size="3" color="red">' + time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time())) + '</font><br>'
    urls = getCVES()
    print urls
    msg = ''
    if(len(urls)==0):
        msg = nowTime + '<p>今日风和日丽，无大事发生!!!</p>'
    else:
        msg_header = '<p>今日CVE一共<font size="3" color="red">' + str(len(urls))+'</font>个。'
        i = 0
        for url in urls:
            cveInfo = getCVEDetail(url)
            if cveInfo is not None:
                i = i + 1
                data = cveInfo.add()
                addData(data)
                msg = msg + cveInfo.show()
        if i == 0:
            msg = nowTime + msg_header +  '根据设置的关键字，未匹配到关注的CVE信息。</p>'
        else:
            msg_key_header = '</p>根据设置的关键字，关注的CVE信息一共<font size="3" color="red">' + str(i)+'</font>个。具体如下：<br><br>'
            msg = nowTime + msg_header + msg_key_header + msg
    sendEmail(msg)
if __name__ == '__main__':
    main()
